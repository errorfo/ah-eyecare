<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Try-On - AH EYECARE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <style>
    #video { 
      transform: scaleX(-1); 
      border-radius: 0.5rem; 
      width: 100%;
      height: auto;
    }
    #overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .video-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
    }
    .frame-thumb {
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 0.5rem;
      transition: border-color 0.2s, transform 0.2s;
    }
    .frame-thumb.selected {
      border-color: #2563eb;
      box-shadow: 0 0 10px rgba(37,99,235,0.5);
      transform: scale(1.05);
    }
    .frame-card:hover .frame-thumb {
      border-color: #3b82f6;
      transform: scale(1.05);
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-6xl mx-auto py-6 px-4">

    <h1 class="text-3xl font-bold mb-6 text-center">Virtual Try-On</h1>

    <!-- Video & AR Overlay -->
    <div class="video-container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

    <!-- Selected Frame Info -->
    <div class="mt-4 text-center">
      <h2 id="frame-name" class="text-xl font-semibold">Select a frame</h2>
      <p id="frame-price" class="text-green-600 font-bold"></p>
      <a id="buy-now-btn" class="inline-block mt-2 px-4 py-2 rounded text-white bg-blue-600 hover:bg-blue-700">
        ðŸ›’ Buy Now
      </a>
    </div>

    <!-- Frame Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mt-6">
      {% for product in frames %}
        <div class="frame-card flex flex-col items-center">
          <img src="{{ product.vr_image_url }}" 
     data-frame="{{ product.vr_image_url }}"
     data-id="{{ product.id or '' }}" 
     data-name="{{ product.name }}" 
     data-price="{{ product.price }}" 
     data-available="{{ 'true' if product.available else 'false' }}"
     class="w-28 h-16 object-contain frame-thumb {% if loop.first %}selected{% endif %}">

          <p class="mt-2 font-semibold text-center">{{ product.name }}</p>
          <p class="text-green-600 font-bold">â‚¹{{ product.price }}</p>

          {% if product.available and product.id %}
    <a href="{{ url_for('product_detail', product_id=product.id) }}" 
       class="mt-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
       ðŸ›’ Buy Now
    </a>
{% else %}
    <button disabled
       class="mt-1 bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed">
       Product Not Available
    </button>
{% endif %}

        </div>
      {% endfor %}
    </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <!-- Consolidated Frame Selection Script -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const frameThumbs = document.querySelectorAll(".frame-thumb");
      const frameName = document.getElementById("frame-name");
      const framePrice = document.getElementById("frame-price");
      const buyNowBtn = document.getElementById("buy-now-btn");

      function selectFrame(frame) {
        // Highlight selected thumbnail
        frameThumbs.forEach(f => f.classList.remove("selected"));
        frame.classList.add("selected");

        // Update info
        frameName.textContent = frame.dataset.name;
        framePrice.textContent = 'â‚¹' + frame.dataset.price;

        // Handle Buy Now button
        // Handle Buy Now button - now goes to product page
if (frame.dataset.available === 'true' && frame.dataset.id) {
  buyNowBtn.href = '/product/' + frame.dataset.id; // Go to product detail page
  buyNowBtn.textContent = 'ðŸ›’ Buy Now';
  buyNowBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
  buyNowBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
} else {
  buyNowBtn.removeAttribute('href');
  buyNowBtn.textContent = 'Product Not Available';
  buyNowBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
  buyNowBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
}


        // Update AR overlay
        if (typeof updateSelectedFrame === 'function') {
          updateSelectedFrame(frame.src);
        }
      }

      // Click events for all thumbnails
      frameThumbs.forEach(f => f.addEventListener('click', () => selectFrame(f)));

      // Auto-select first frame on load
      if (frameThumbs.length > 0) {
        selectFrame(frameThumbs[0]);
      }
    });
  </script>

  <script src="{{ url_for('static', filename='js/tryon.js') }}"></script>
</body>
</html>
